name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      target_version:
        description: 'Target deployment version to rollback to (e.g., v2024.01.15-production-abc12345-1705123456)'
        required: true
        type: string
      confirm_rollback:
        description: 'Confirm rollback (type "ROLLBACK" to confirm)'
        required: true
        type: string

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
      target-version: ${{ steps.validate.outputs.target-version }}
      bucket-name: ${{ steps.validate.outputs.bucket-name }}
      cloudfront-id: ${{ steps.validate.outputs.cloudfront-id }}
      cloudfront-domain: ${{ steps.validate.outputs.cloudfront-domain }}
    
    steps:
      - name: Validate rollback confirmation
        id: validate
        run: |
          if [[ "${{ github.event.inputs.confirm_rollback }}" != "ROLLBACK" ]]; then
            echo "‚ùå Rollback confirmation failed. You must type 'ROLLBACK' to confirm."
            exit 1
          fi
          
          echo "‚úÖ Rollback confirmation validated"
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "target-version=${{ github.event.inputs.target_version }}" >> $GITHUB_OUTPUT
          
          # Set environment-specific outputs (these would normally come from Terraform)
          if [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
            echo "bucket-name=novacorevectra-staging" >> $GITHUB_OUTPUT
            echo "cloudfront-id=" >> $GITHUB_OUTPUT
            echo "cloudfront-domain=" >> $GITHUB_OUTPUT
          else
            echo "bucket-name=novacorevectra-production" >> $GITHUB_OUTPUT
            echo "cloudfront-id=E1234567890ABC" >> $GITHUB_OUTPUT
            echo "cloudfront-domain=d1234567890abc.cloudfront.net" >> $GITHUB_OUTPUT
          fi

      - name: Log rollback request
        run: |
          echo "üîÑ Rollback Request Details:"
          echo "  Environment: ${{ github.event.inputs.environment }}"
          echo "  Target Version: ${{ github.event.inputs.target_version }}"
          echo "  Requested by: ${{ github.actor }}"
          echo "  Workflow Run: ${{ github.run_id }}"

  rollback-staging:
    name: Rollback Staging
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: needs.validate-rollback.outputs.environment == 'staging'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Load staging environment configuration
        run: |
          echo "Loading staging environment configuration..."
          set -a
          source .github/config/staging.env
          set +a
          
          # Export variables for subsequent steps
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          echo "S3_BUCKET_PREFIX=$S3_BUCKET_PREFIX" >> $GITHUB_ENV
          echo "HTML_CACHE_CONTROL=$HTML_CACHE_CONTROL" >> $GITHUB_ENV
          echo "STATIC_CACHE_CONTROL=$STATIC_CACHE_CONTROL" >> $GITHUB_ENV
          echo "API_CACHE_CONTROL=$API_CACHE_CONTROL" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIMEOUT=$DEPLOYMENT_TIMEOUT" >> $GITHUB_ENV
          
          echo "Staging configuration loaded successfully"

      - name: Setup Terraform (to get current resource info)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.0"

      - name: Initialize Terraform for staging
        working-directory: terraform
        run: |
          echo "Initializing Terraform for staging environment..."
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=staging/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TERRAFORM_STATE_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Get current staging resources
        id: get-resources
        working-directory: terraform
        run: |
          BUCKET_NAME=$(terraform output -raw s3_bucket_name || echo "${{ needs.validate-rollback.outputs.bucket-name }}")
          echo "bucket-name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "Staging S3 bucket: $BUCKET_NAME"

      - name: Make rollback scripts executable
        run: |
          chmod +x .github/scripts/rollback.sh
          chmod +x .github/scripts/deployment-versioning.sh
          chmod +x .github/scripts/health-check.sh

      - name: List recent deployments
        run: |
          echo "üìã Recent staging deployments:"
          ./.github/scripts/deployment-versioning.sh list \
            ${{ steps.get-resources.outputs.bucket-name }} \
            staging \
            10

      - name: Perform rollback to staging
        run: |
          echo "üîÑ Performing rollback to staging environment..."
          ./.github/scripts/rollback.sh \
            staging \
            ${{ needs.validate-rollback.outputs.target-version }} \
            ${{ steps.get-resources.outputs.bucket-name }} \
            "" \
            "" \
            true

      - name: Output rollback results
        run: |
          echo "üéâ Staging rollback completed!"
          echo "Environment: staging"
          echo "Rolled back to: ${{ needs.validate-rollback.outputs.target-version }}"
          echo "Previous version: ${PREVIOUS_VERSION:-'unknown'}"
          echo "S3 Bucket: ${{ steps.get-resources.outputs.bucket-name }}"
          echo "Website URL: http://${{ steps.get-resources.outputs.bucket-name }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"

  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: needs.validate-rollback.outputs.environment == 'production'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Load production environment configuration
        run: |
          echo "Loading production environment configuration..."
          set -a
          source .github/config/production.env
          set +a
          
          # Export variables for subsequent steps
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          echo "S3_BUCKET_PREFIX=$S3_BUCKET_PREFIX" >> $GITHUB_ENV
          echo "HTML_CACHE_CONTROL=$HTML_CACHE_CONTROL" >> $GITHUB_ENV
          echo "STATIC_CACHE_CONTROL=$STATIC_CACHE_CONTROL" >> $GITHUB_ENV
          echo "API_CACHE_CONTROL=$API_CACHE_CONTROL" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIMEOUT=$DEPLOYMENT_TIMEOUT" >> $GITHUB_ENV
          echo "INVALIDATION_TIMEOUT=$INVALIDATION_TIMEOUT" >> $GITHUB_ENV
          
          echo "Production configuration loaded successfully"

      - name: Setup Terraform (to get current resource info)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.0"

      - name: Initialize Terraform for production
        working-directory: terraform
        run: |
          echo "Initializing Terraform for production environment..."
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=production/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TERRAFORM_STATE_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Get current production resources
        id: get-resources
        working-directory: terraform
        run: |
          BUCKET_NAME=$(terraform output -raw s3_bucket_name || echo "${{ needs.validate-rollback.outputs.bucket-name }}")
          CLOUDFRONT_ID=$(terraform output -raw cloudfront_distribution_id || echo "${{ needs.validate-rollback.outputs.cloudfront-id }}")
          CLOUDFRONT_DOMAIN=$(terraform output -raw cloudfront_domain_name || echo "${{ needs.validate-rollback.outputs.cloudfront-domain }}")
          echo "bucket-name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "cloudfront-id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
          echo "cloudfront-domain=$CLOUDFRONT_DOMAIN" >> $GITHUB_OUTPUT
          echo "Production S3 bucket: $BUCKET_NAME"
          echo "Production CloudFront distribution: $CLOUDFRONT_ID"
          echo "Production CloudFront domain: $CLOUDFRONT_DOMAIN"

      - name: Make rollback scripts executable
        run: |
          chmod +x .github/scripts/rollback.sh
          chmod +x .github/scripts/deployment-versioning.sh
          chmod +x .github/scripts/health-check.sh

      - name: List recent deployments
        run: |
          echo "üìã Recent production deployments:"
          ./.github/scripts/deployment-versioning.sh list \
            ${{ steps.get-resources.outputs.bucket-name }} \
            production \
            10

      - name: Perform rollback to production
        run: |
          echo "üîÑ Performing rollback to production environment..."
          ./.github/scripts/rollback.sh \
            production \
            ${{ needs.validate-rollback.outputs.target-version }} \
            ${{ steps.get-resources.outputs.bucket-name }} \
            ${{ steps.get-resources.outputs.cloudfront-id }} \
            ${{ steps.get-resources.outputs.cloudfront-domain }} \
            true

      - name: Output rollback results
        run: |
          echo "üéâ Production rollback completed!"
          echo "Environment: production"
          echo "Rolled back to: ${{ needs.validate-rollback.outputs.target-version }}"
          echo "Previous version: ${PREVIOUS_VERSION:-'unknown'}"
          echo "S3 Bucket: ${{ steps.get-resources.outputs.bucket-name }}"
          echo "CloudFront Distribution: ${{ steps.get-resources.outputs.cloudfront-id }}"
          echo "CloudFront Domain: ${{ steps.get-resources.outputs.cloudfront-domain }}"
          echo "Website URL: http://${{ steps.get-resources.outputs.bucket-name }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          echo "CDN URL: https://${{ steps.get-resources.outputs.cloudfront-domain }}"
          echo "Custom Domain: https://${{ vars.DOMAIN_NAME || 'novacorevectra.net' }}"

  notify-rollback:
    name: Notify Rollback Results
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback-staging, rollback-production]
    if: always() && needs.validate-rollback.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make notification script executable
        run: chmod +x .github/scripts/notify-rollback.sh

      - name: Determine rollback status
        id: status
        run: |
          if [[ "${{ needs.rollback-staging.result }}" == "success" || "${{ needs.rollback-production.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Rollback completed successfully" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Rollback failed" >> $GITHUB_OUTPUT
          fi

      - name: Send rollback notifications
        run: |
          echo "üì¢ Sending rollback notifications..."
          ./.github/scripts/notify-rollback.sh send \
            ${{ needs.validate-rollback.outputs.environment }} \
            ${{ needs.validate-rollback.outputs.target-version }} \
            ${{ steps.status.outputs.status }} \
            "${PREVIOUS_VERSION:-unknown}" \
            "${{ github.actor }}" \
            "${{ github.run_id }}" \
            "$(date --iso-8601=seconds)"

      - name: Generate rollback summary report
        run: |
          echo "üìã Generating rollback summary report..."
          ./.github/scripts/notify-rollback.sh summary \
            ${{ needs.validate-rollback.outputs.environment }} \
            ${{ needs.validate-rollback.outputs.target-version }} \
            ${{ steps.status.outputs.status }} \
            "${PREVIOUS_VERSION:-unknown}" \
            "${{ github.actor }}" \
            "${{ github.run_id }}"

      - name: Output final rollback status
        run: |
          echo "üéØ Final Rollback Status"
          echo "========================"
          echo "Status: ${{ steps.status.outputs.status }}"
          echo "Message: ${{ steps.status.outputs.message }}"
          echo "Environment: ${{ needs.validate-rollback.outputs.environment }}"
          echo "Target Version: ${{ needs.validate-rollback.outputs.target-version }}"
          echo "Performed by: ${{ github.actor }}"
          echo "Workflow Run: ${{ github.run_id }}"
          echo "Timestamp: $(date --iso-8601=seconds)"
          echo ""
          echo "üîó Useful Links:"
          echo "- Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- Repository: https://github.com/${{ github.repository }}"
          if [[ "${{ needs.validate-rollback.outputs.environment }}" == "production" ]]; then
            echo "- Website: https://${{ vars.DOMAIN_NAME || 'novacorevectra.net' }}"
          else
            echo "- Website: https://staging.${{ vars.DOMAIN_NAME || 'novacorevectra.net' }}"
          fi
          echo ""
          echo "üìù Note: Enhanced notifications (email, Slack, CloudWatch) will be implemented in task 9"